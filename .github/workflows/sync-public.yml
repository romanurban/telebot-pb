name: Sync to Public Branch

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  sync:
    if: github.repository == 'romanurban/telebot'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout master
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Prepare clean copy
        run: |
          # Copy to temp dir, excluding personal data
          mkdir -p ../clean-copy
          rsync -av --exclude='.git' \
            --exclude='prompts/neuroyury_bot' \
            --exclude='prompts/neuromans_bot' \
            --exclude='prompts/neuromaksim_bot' \
            --exclude='dataset' \
            --exclude='chat_history' \
            ./ ../clean-copy/

      - name: Sync to public branch
        run: |
          # Fetch or create public branch
          git fetch origin public:public || true
          git checkout public || git checkout --orphan public

          # Clear and copy clean files
          git rm -rf . || true
          cp -r ../clean-copy/. ./

          git add -A
          git diff --staged --quiet || git commit -m "chore: sync from master"
          git push origin public --force

      - name: Push to public repository
        run: |
          git clone https://${{ secrets.PUBLIC_REPO_TOKEN }}@github.com/romanurban/telebot-pb.git ../telebot-pb
          rsync -av --delete --exclude='.git' ../clean-copy/ ../telebot-pb/
          cd ../telebot-pb
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "Sync from private repo"
          git branch -M main
          git push origin main --force
